name: Export Crunched Textures

on:
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    container:
      image: unityci/editor:ubuntu-2022.3.22f1-base-3.1.0

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '16'

      - name: Install node package, `unity-license-activate`
        run: npm install --global unity-license-activate

      - name: Activate the license
        run: unity-license-activate "${{ secrets.UNITY_EMAIL }}" "${{ secrets.UNITY_PASSWORD }}" "${{ needs.request_alf.outputs.alf }}"

      - name: Read ulf
        id: ulfRead
        uses: juliangruber/read-file-action@v1.1.4
        with:
          path: ${{ env.ULF_FILE }}

      - name: Update secret UNITY_LICENSE
        uses: hmanzur/actions-set-secret@v2.0.0
        with:
          name: 'UNITY_LICENSE'
          value: '${{ steps.ulfRead.outputs.content }}'
          token: ${{ secrets.ACCESS_TOKEN }}

#      - name: Set up Unity license manually
#        run: |
#          mkdir -p ~/.local/share/unity3d
#          mkdir -p ~/.local/share/unity3d/Unity
#          mkdir -p ~/.cache/unity3d
#          mkdir -p ~/.config/unity3d
#          mkdir -p ./license
#          echo '${{ secrets.UNITY_LICENSE }}' > ~/.local/share/unity3d/Unity_lic.ulf
#          echo '${{ secrets.UNITY_LICENSE }}' > ~/.local/share/unity3d/Unity/Unity_lic.ulf
#          echo '${{ secrets.UNITY_LICENSE }}' > ./license/Unity_lic.ulf
          

#      - name: Debug whoami and license path
#        run: |
#          whoami
#          ls -la ~/.local/share/unity3d/
#          ls -la ~/.local/share/unity3d/Unity/

#      - name: Set up Unity license
#        run: |
#          mkdir -p ~/.local/share/unity3d
#          echo "${{ secrets.UNITY_LICENSE }}" > ~/.local/share/unity3d/Unity_lic.ulf
#          echo "${{ secrets.UNITY_LICENSE }}" > ~/.local/share/unity3d/Unity_v2022.x.ulf

#      - name: License Auth
#        run: |
#          unity-editor \
#            -batchmode \
#            -nographics \
#            -quit \
#            -silent-crashes \
#            -logFile - \
#            -manualLicenseFile ./license/Unity_lic.ulf

      - name: Export Crunched Textures
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 640x480x24' \
          unity-editor \
            -batchmode \
            -nographics \
            -projectPath . \
            -executeMethod ExportCrunchedBytes.Export \
            -logFile - \
            -quit

#      - name: Run custom Unity method
#        uses: game-ci/unity-builder@v4
#        env:
#          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
#          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
#          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
#        with:
#          unityVersion: 2022.3.22f1
#          targetPlatform: StandaloneWindows64
#          customParameters: -executeMethod ExportCrunchedBytes.Export

      - name: Upload Unity log if failed
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: unity-editor-log
          path: ~/.config/unity3d/Editor.log

      - name: Upload exported bytes
        uses: actions/upload-artifact@v4
        with:
          name: crunched-bytes
          path: Assets/Output/
